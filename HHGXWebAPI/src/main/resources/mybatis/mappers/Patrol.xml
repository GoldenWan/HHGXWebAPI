<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hhgx.soft.mappers.PatrolMapper">


	<select id="gePatrolRecordByOrgCount" resultType="int">
		SELECT
		count(*)
		FROM
		(
		SELECT
		ul.UserCheckId,
		ul.UserCheckTime,
		ul.OrgUserId,
		ul.OrgManagerId,
		ul.SubmitTime,
		ul.Remarks,
		ul.SubmitStatet,
		ui.UserCheckResult
		FROM
		uerchecklist ul
		INNER JOIN usercheckinfo ui ON ul.userCheckId = ui.userCheckId
		WHERE
		ul.orgid = #{orgID}
		) n

	</select>

	<select id="getPatrolRecordByOrg" resultMap="patrolRecordMap">
		SELECT
		ul.UserCheckId,
		ul.UserCheckTime,
		ul.OrgUserId OrgUser,
		ul.OrgManagerId
		OrgManager,
		ul.SubmitTime,
		ul.Remarks,
		ul.SubmitStatet,
		ui.UserCheckResult
		FROM
		uerchecklist ul
		INNER JOIN usercheckinfo ui ON ul.userCheckId = ui.userCheckId
		WHERE
		ul.orgid = #{orgID} and ul.SubmitTime BETWEEN #{startDate} and
		#{endTime}
		limit #{startPos},#{pageSize}
	</select>

	<resultMap type="patrolRecord" id="patrolRecordMap">
		<id column="UserCheckId" property="userCheckId" />
		<result column="UserCheckTime" property="userCheckTime" />
		<result column="OrgUser" property="orgUser" />
		<result column="OrgManager" property="orgManager" />
		<result column="SubmitTime" property="submitTime" />
		<result column="Remarks" property="remarks" />
		<result column="SubmitStatet" property="submitStatet" />
		<result column="UserCheckResult" property="userCheckResult" />
	</resultMap>
	<delete id="deleteCheckRecord">
		DELETE
		FROM
		uerchecklist
		WHERE
		UserCheckId = #{userCheckId};
		<!-- 使用了级联删除，但需要代码删除与之相关的巡查照片 -->
	</delete>
	<insert id="addUserCheckList">
		insert into uerchecklist(orgid, UserCheckTime,OrgUserId,OrgManager)
		values (#{orgid},#{userCheckTime},#{orgUserId},#{orgManager});

	</insert>
	<insert id="addUserCheckInfoByOrgid">
	INSERT INTO usercheckinfo (UserCheckId, ProjectId)
	VALUES
		(
			#{userCheckId},
			(
				SELECT
					u.ProjectId
				FROM
					usercheckcontent u
				WHERE
					orgid = #{orgid}
			)
		)
		
	</insert>
	<update id="updateUserCheckList">
	UPDATE uerchecklist
	SET UserCheckTime = #{userCheckTime}
	WHERE
	UserCheckId = #{userCheckId}
	</update>
	<select id="findNullUserCheckInfo" resultType="userCheckInfo">
	SELECT
		ui.UserCheckId,
		ui.ProjectId,
		ui.UserCheckResult,
		ui.FaultShow,
		ui.YnHanding,
		ui.Handingimmediately
	FROM
		uerchecklist ul
	INNER JOIN usercheckinfo ui ON ul.UserCheckId = ui.UserCheckId
	WHERE
		ul.UserCheckId = #{userCheckId}
	</select>
	<update id="updateSubmitState">
	UPDATE uerchecklist q
	SET q.SubmitStatet = #{submitStatet}
	WHERE
		q.UserCheckId = #{userCheckId}
	</update>
	
</mapper>